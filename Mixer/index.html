<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mixer</title>
    <style>
        .trackDiv
        {
            width: 200px;
            height: 100%;
            float: left;
            text-align: center;
        }
        .verticalSlider
        {
            width: 50px;
            height: 90%;
            writing-mode: bt-lr; /* IE */
            -webkit-appearance: slider-vertical; /* WebKit */
        }
    </style>
    <script>
        class Buffer
        {
            constructor()
            {
                this.audioData = null;
            }

            loadSound(context, url, callback)
            {
                var request = new XMLHttpRequest();
                request.open('GET', url, true);
                request.responseType = 'arraybuffer';
                let thisBuffer = this;
                request.onload = function()
                {
                    context.decodeAudioData(request.response, function(buffer) {
                        thisBuffer.audioData = buffer;
                        callback();
                    },
                    function(e){"Error with decoding audio data" + e.err});
                };
                request.send();
            }

            getAudioData()
            {
                return this.audioData;
            }
        }

        class Slider
        {
            constructor(context, title, sliderDiv, gainNode)
            {
		        var trackDiv = document.createElement("div");
                trackDiv.className = "trackDiv";
		        var titleDiv = document.createElement("div");
                titleDiv.innerHTML = title;
		        var slider = document.createElement("input");
                slider.type = "range";
                slider.min = 0;
                slider.max = 1;
                slider.step = 0.1
                slider.value = 1;
                slider.className = "verticalSlider";
                slider.title = title;
                if (slider.orient) slider.orient="vertical";
                slider.addEventListener('change', function() {
                    gainNode.gain.setValueAtTime(this.value, context.currentTime);
                });
		        sliderDiv.appendChild(trackDiv);
		        trackDiv.appendChild(titleDiv);
		        trackDiv.appendChild(slider);
            }
        }

        class Song
        {
            constructor(context, songData, sliderDiv, splitsDiv)
            {
                // Store the song data
                this.songData = songData;
                this.buffers = [];
                this.sources = [];
                this.gainNodes = [];
                this.trackSliders = [];
                this.started = false;
                this.context = context;

                while(sliderDiv.firstChild){
                    sliderDiv.removeChild(sliderDiv.firstChild);
                }

                while(splitsDiv.firstChild){
                    splitsDiv.removeChild(splitsDiv.firstChild);
                }

                this._load(sliderDiv, splitsDiv);
            }

            _load(sliderDiv, splitsDiv)
            {
                // Load
		        var i;
                var loaded = 0;
                for(i=0;i < this.songData.tracks.length;i++)
		        {
                    this.gainNodes[i] = this.context.createGain();
                    this.gainNodes[i].connect(this.context.destination);

                    this.trackSliders[i] = new Slider(
                        this.context,
                        this.songData.tracks[i].name,
                        sliderDiv,
                        this.gainNodes[i]);

                    this.buffers[i] = new Buffer();
                    var thisSong = this;
                    this.buffers[i].loadSound(
                        this.context,
                        this.songData.tracks[i].url,
                        function(){
                        if(++loaded == thisSong.songData.tracks.length)
                            thisSong.play();
                        });
                }

                var thisSong = this;
                for(i=0;i < this.songData.splits.length;i++)
                {

                    var splitbutton = document.createElement("button");
                    splitbutton.textContent = this.songData.splits[i].name;
                    splitbutton.pos = i;
                    splitbutton.onclick = function(){ thisSong.playFrom(this.pos); };
                    splitsDiv.appendChild(splitbutton);
                }
            }

            play()
            {
                // Play from start
                this.stop();
                this._play(0);
            }

            stop()
            {
                // Stop
                if(this.started) {
                    for(var i=0;i<this.songData.tracks.length;i++)
                    {
                        this.sources[i].stop();
                        this.sources[i] = null;
                    }
                    this.started = false;
                }
            }

            playFrom(split)
            {
                // Play from split location
                var secs = this.songData.splits[split].time;
                this.stop();
                this._play(secs);
            }

            _play(secs)
            {
                if(!this.started) {
	                for(var i=0;i<this.songData.tracks.length;i++) {
                        var source = this.context.createBufferSource();
                        source.buffer = this.buffers[i].audioData;
                        source.connect(this.gainNodes[i]);
                        source.start(0,secs);
                        this.sources[i] = source;
                    }
                    this.started = true;            
                }
            }
        }

        function onStart()
        {
            song.play();
        }

        function onStop()
        {
            song.stop();
        }

        function onChorus()
        {
            song.playFrom(1);
        }

        function loadSongs()
        {
            var request = new XMLHttpRequest();
            request.open('GET', "songs.json", true);
            let thisBuffer = this;
            request.onload = function()
            {
                songData = JSON.parse(request.response);
                populateSongList();
                //loadSong(0);
            };
            request.send();
        }

        function addToSelect(select, text, value)
        {
            var option = document.createElement("option");
            option.text = text;
            option.value = value;
            select.appendChild(option);
        }

        function populateSongList()
        {
            var pSelect = document.getElementById("selSong");
            addToSelect(pSelect, "Select Song","");
            for(var i=0;i<songData.songs.length;i++)
                addToSelect(pSelect, songData.songs[i].name,i);
        }

        function selectSong(select)
        {
            if(select.value != "")
            {
                var idx = parseInt(select.value);
                pSongIO.style.display = "block";
                loadSong(idx);
            }
            else
            {
                song.stop();
                pSongIO.style.display = "none";
            }
        }

        function loadSong(index)
        {
            song = new Song(audioCtx, songData.songs[index], pVolumeControls, pSplits);
        }


    </script>
</head>
<body>
    <select id="selSong" onchange="selectSong(this)"></select><br /><br />
    <div id="songUI" style="display:none">
        <div id="volumecontrols">
        </div>
        <div style="clear:both"><br /><br /></div>
        <div>
            <button id="stop" onclick="onStop()">Stop</button>
            <button id="start" onclick="onStart()">Start</button>
        </div>
        <div id="splits"></div>
    </div>
    <script>
        var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        var pVolumeControls = document.getElementById("volumecontrols");
        var pSplits = document.getElementById("splits");
        var pSongIO = document.getElementById("songUI");
        var songData;
        var song;
        loadSongs();
    </script>
</body>
</html>
